name: Constant-Time Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 00:00 UTC for thorough CT analysis
    - cron: '0 0 * * 0'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-D warnings"

jobs:
  ct-verification:
    name: DudeCT Timing Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-ct-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-ct-

    - name: Build CT verification benchmarks
      run: cargo build --release --bench ct_verification

    - name: Run constant-time verification (quick check)
      id: ct_quick
      run: |
        echo "Running DudeCT constant-time verification..."

        # Run benchmarks for 30 seconds each, capture output
        CT_BENCH="./target/release/deps/ct_verification-*"
        CT_BINARY=$(ls $CT_BENCH 2>/dev/null | head -1)

        if [ -z "$CT_BINARY" ]; then
          echo "Error: CT verification binary not found"
          exit 1
        fi

        echo "Binary: $CT_BINARY"

        # Create output directory
        mkdir -p ct_results

        # Run each benchmark for 30 seconds and capture results
        BENCHMARKS=(
          "ct_eq_equal_vs_different"
          "ct_eq_early_vs_late_diff"
          "ct_array_eq_verification"
          "ct_copy_bytes_choice_verification"
          "ct_copy_bytes_length_verification"
          "ct_select_verification"
        )

        FAILED=0

        for bench in "${BENCHMARKS[@]}"; do
          echo ""
          echo "=== Testing: $bench ==="

          # Run benchmark in background, capture output
          timeout 30s $CT_BINARY --continuous "$bench" > "ct_results/${bench}.log" 2>&1 || true

          # Extract the last max_t value
          if [ -f "ct_results/${bench}.log" ]; then
            # Get last line with max_t value
            LAST_LINE=$(grep "max t =" "ct_results/${bench}.log" | tail -1)
            echo "Last measurement: $LAST_LINE"

            # Extract max_t value (handles both positive and negative)
            MAX_T=$(echo "$LAST_LINE" | grep -oP 'max t = [+-]?\d+\.?\d*' | grep -oP '[+-]?\d+\.?\d*$' || echo "0")

            # Get absolute value
            ABS_MAX_T=$(echo "$MAX_T" | tr -d '-' | tr -d '+')

            echo "max_t = $MAX_T (absolute: $ABS_MAX_T)"

            # Check if max_t exceeds threshold (5.0 indicates non-constant-time)
            if [ -n "$ABS_MAX_T" ]; then
              EXCEEDS=$(echo "$ABS_MAX_T > 4.5" | bc -l 2>/dev/null || echo "0")
              if [ "$EXCEEDS" = "1" ]; then
                echo "⚠️ WARNING: $bench shows potential timing leak (|t| = $ABS_MAX_T > 4.5)"
                FAILED=1
              else
                echo "✅ PASS: $bench is constant-time (|t| = $ABS_MAX_T < 4.5)"
              fi
            else
              echo "⚠️ Could not parse max_t value"
            fi
          else
            echo "⚠️ No output file for $bench"
          fi
        done

        echo ""
        echo "=== Summary ==="
        if [ "$FAILED" = "1" ]; then
          echo "❌ Some constant-time tests showed potential timing leaks"
          echo "   Review the detailed logs in ct_results/"
          echo "   Note: High |t| values (>5) indicate non-constant-time behavior"
          exit 1
        else
          echo "✅ All constant-time tests passed"
        fi

    - name: Upload CT verification results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ct-verification-results
        path: ct_results/
        retention-days: 30

  ct-extended:
    name: Extended CT Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-ct-extended-${{ hashFiles('**/Cargo.lock') }}

    - name: Build CT verification benchmarks
      run: cargo build --release --bench ct_verification

    - name: Run extended constant-time verification (5 minutes per test)
      run: |
        echo "Running extended DudeCT analysis (5 min per test)..."

        CT_BINARY=$(ls ./target/release/deps/ct_verification-* 2>/dev/null | head -1)
        mkdir -p ct_results_extended

        BENCHMARKS=(
          "ct_eq_equal_vs_different"
          "ct_eq_early_vs_late_diff"
          "ct_array_eq_verification"
          "ct_copy_bytes_choice_verification"
          "ct_copy_bytes_length_verification"
          "ct_select_verification"
          "ct_eq_random_data"
          "ct_eq_empty_slices"
        )

        for bench in "${BENCHMARKS[@]}"; do
          echo ""
          echo "=== Extended Testing: $bench (5 minutes) ==="
          timeout 300s $CT_BINARY --continuous "$bench" > "ct_results_extended/${bench}.log" 2>&1 || true

          if [ -f "ct_results_extended/${bench}.log" ]; then
            LAST_LINE=$(grep "max t =" "ct_results_extended/${bench}.log" | tail -1)
            echo "Final measurement: $LAST_LINE"
          fi
        done

        echo ""
        echo "Extended analysis complete. Results saved to ct_results_extended/"

    - name: Upload extended CT results
      uses: actions/upload-artifact@v4
      with:
        name: ct-verification-extended-results
        path: ct_results_extended/
        retention-days: 90
